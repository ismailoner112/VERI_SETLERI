
import os, json, joblib, warnings, shutil
from pathlib import Path
warnings.filterwarnings("ignore")

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import accuracy_score, f1_score, confusion_matrix
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import RandomForestClassifier
from sklearn.neighbors import KNeighborsClassifier
from xgboost import XGBClassifier

# ─── Sabitler ───────────────────────────────────────────────────────────────
CSV_PATH    = Path(r"C:\Users\İSO\Desktop\VERI_SETLERI\Android_Malware\Android_Malware_1.csv")
DATASET_DIR = CSV_PATH.parent
PROC_DIR    = DATASET_DIR / "processed"; PROC_DIR.mkdir(exist_ok=True)
CM_DIR      = PROC_DIR / "model_cms";   CM_DIR.mkdir(exist_ok=True)
LABEL_NAMES = ["Adware", "Scareware", "SMS_Malware", "Benign"]
SEED        = 42

# ─── 1. Veri Yükle & Böl ───────────────────────────────────────────────────
if not CSV_PATH.exists():
    raise FileNotFoundError(f"CSV bulunamadı: {CSV_PATH}")

df = pd.read_csv(CSV_PATH)
print("Temiz veri boyutu:", df.shape)

X = df.drop(columns=["Label"])
y = df["Label"]

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, stratify=y, random_state=SEED)

# Sayısal özellikleri ölçekle (KNN/LogReg için önemli)
scaler = StandardScaler()
X_train_sc = scaler.fit_transform(X_train)
X_test_sc  = scaler.transform(X_test)

# ─── 2. Model Havuzu ───────────────────────────────────────────────────────
MODELS = {
    "LogisticRegression": LogisticRegression(max_iter=1000, solver="saga", multi_class="multinomial", n_jobs=-1),
    "RandomForest":       RandomForestClassifier(n_estimators=200, random_state=SEED, n_jobs=-1),
    "KNN":                KNeighborsClassifier(n_neighbors=5),
    "XGBoost":            XGBClassifier(
                              n_estimators=600, max_depth=10, learning_rate=0.1,
                              subsample=0.9, colsample_bytree=0.9,
                              objective="multi:softprob", eval_metric="mlogloss",
                              random_state=SEED, n_jobs=-1)
}

summary_rows = []

# ─── 3. Eğit – Değerlendir – Kaydet ─────────────────────────────────────────
for name, model in MODELS.items():
    print(f"\n▶︎ {name} eğitiliyor…")

    if name in {"KNN", "LogisticRegression"}:
        model.fit(X_train_sc, y_train)
        preds = model.predict(X_test_sc)
        bundle = {"scaler": scaler, "clf": model}
    else:
        model.fit(X_train, y_train)
        preds = model.predict(X_test)
        bundle = {"scaler": None, "clf": model}

    acc = accuracy_score(y_test, preds)
    f1  = f1_score(y_test, preds, average="macro")
    summary_rows.append({"model": name, "accuracy": acc, "macro_f1": f1})

    # Confusion Matrix
    cm = confusion_matrix(y_test, preds, labels=range(len(LABEL_NAMES)))
    plt.figure(figsize=(5,4))
    sns.heatmap(cm, annot=True, fmt="d", cmap="Blues",
                xticklabels=LABEL_NAMES, yticklabels=LABEL_NAMES)
    plt.title(f"{name} Confusion Matrix")
    plt.xlabel("Tahmin"); plt.ylabel("Gerçek")
    plt.tight_layout()
    plt.savefig(CM_DIR / f"{name}_cm.png", dpi=300)
    plt.close()

    # Model paketi kaydet
    joblib.dump(bundle, PROC_DIR / f"{name}.pkl")
    print(f"   ↳ Kaydedildi: {PROC_DIR}/{name}.pkl (F1={f1:.3f})")

# ─── 4. En İyi Model & Özet ────────────────────────────────────────────────
summary_df = pd.DataFrame(summary_rows).sort_values("macro_f1", ascending=False)
summary_df.to_csv(DATASET_DIR / "Android_models_summary.csv", index=False)

best_model_name = summary_df.iloc[0]["model"]
shutil.copy(PROC_DIR / f"{best_model_name}.pkl", PROC_DIR / "best_model.pkl")
print(f"\n🏆 En iyi model: {best_model_name} (F1={summary_df.iloc[0]['macro_f1']:.3f}) → {PROC_DIR}/best_model.pkl")

print("\n✅ Eğitim tamamlandı – Sonuçlar:")
print(summary_df)
print(f"Tüm çıktı → {PROC_DIR}")
